# MQTT介绍

### 介绍

WebSphere MQ Telemetry Transport (MQTT) 是一项异步消息传输协议，专门为物联网所定制的重要的轻量级消息传输协议。

MQTT是轻量级基于代理的发布 / 订阅的消息传输协议，设计思想是开放、简单、轻量、易于实现。

### 特点

- 使用**发布／订阅**消息模式，提供一对多的消息发布，解除应用程序耦合
- 对**负载内容屏蔽**的消息传输
- 使用**TCP／IP**提供网络连接
- 有三种消息发布服务质量
  - “**至多一次**”，消息发布完全依赖底层TCP/IP网络。会发生消息丢失或重复。这一级别可用于如下情况，环境传感器数据，丢失一次读记录无所谓，因为不久后还会有第二次发送
  - “**至少一次**”，确保消息到达，但消息重复可能会发生
  - “**只有一次**”，确保消息到达一次。这一级别可用于如下情况，在计费系统中，消息重复或丢失会导致不正确的结果。
- **小型传输**，开销很小（固定长度的头部是2字节），协议交换最小化，以降低网络流量
- 使用Last Will和Testament特性通知有关各方客户端**异常中断**的机制

### 推送服务

推送服务表现为客户端能自**动收到服务器发送过来的数据和信息**。

推送服务本质上是服务器主动将消息，数据发送到客户端，而不是客户端主动去服务器请求数据。这种推送只需要客户端与服务器连接后，在有数据的情况下，服务器端马上将数据发送到客户端。这里的客户端可以是多种类型的，比如比较常见的浏览器，移动应用等等。

推送服务的实现方式大致可分为 **Poll 和 Push** 模式：

- **Poll模式**

Poll 模式，本质上是”伪推送”模式，或者叫**短轮询**模式。是客户端通过设定固定的时间间隔，然后在时间间隔到达后，客户端主动向服务器发送请求，去更新是否有新数据。这种模式的特点是，客户端需要不停的轮询访问服务器获取信息

- **Push模式**

Push 模式，一般意义上使用**长连接**去建立一个客户端到服务器的双向数据通道，只要在连接建立后，一旦一方有数据更新，就可以马上通过双向的数据通道向对方发送数据，平时在没有数据时，通过一些**心跳等机制**维持通道连接。

Push 模式的特点，简化的客户端的开发，数据能近乎实时的发送到对方。但其在设备资源消耗和网络流量控制方面，根据其使用的不同协议会有很大不同，特别是在移动推送领域，长连接对移动设备电量和网络流量的消耗要求较高。同时，由于需要维护长连接，对服务器在高并发连接的处理能力和性能也有很高要求

### MQTT WebSocket JavaScript API 的功能

- Connect 连接

MQTT 客户端负责向 MQTT 服务器发起连接操作，并开始计时，在超时期里接收到正确连接响应，则连接成功，负责连接超时。任何数据的发送或者收到，都将启动新的超时计时，在整个超时完成后没有数据的发送或者接收时，发送心跳以维持连接状态。

- DisConnect 断开连接

MQTT 客户端或者服务器发起连接断开命令。在发出连接断开命令后，开始超时计时，在超时内成功收到断开响应，双方设置其相应连接状态为断开；超时后尚未成功接收响应，则开始重发连接命令，直到重发次数到达系统设置上限。否则，设置对应原因。

- Subscribe 订购

在双方连接建立后，MQTT 客户端发送订购消息，来订购主题，并设置相应质量服务级别，在接收到订购确认后，自动接收在此主题上的任何消息。

- UnSubscribe 取消订购

在双方连接建立后，MQTT 客户端发送取消订购消息，来取消订购主题，在接收到取消订购确认后，在原来主题上的任何消息将不再推送到此客户端。

- Publish 发布

在双方连接建立后，MQTT 客户端将业务数据放入发布消息的消息体中，通过发布消息，发布在某主题上，此消息按照不同的消息服务质量级别，发布到不同的订购者客户端。

- Will 主题和消息

### MQTT原理

实现MQTT协议需要客户端和服务器端通讯完成，在通讯过程中，MQTT协议中有三种身份：发布者（Publish）、代理（Broker）（服务器）、订阅者（Subscribe）。

其中，消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。

MQTT传输的消息分为：**主题**（Topic）和**负载**（payload）两部分：

（1）Topic，可以理解为消息的类型，订阅者订阅（Subscribe）后，就会收到该主题的消息内容（payload）；

（2）payload，可以理解为消息的内容，是指订阅者具体要使用的内容。

MQTT会构建底层网络传输：它将建立客户端到服务器的连接，提供两者之间的一个有序的、无损的、基于字节流的双向传输。当应用数据通过MQTT网络发送时，MQTT会把与之相关的服务质量（QoS）和主题名（Topic）相关连。

#### MQTT数据包

在MQTT协议中，一个MQTT数据包由：固定头（Fixed header）、可变头（Variable header）、消息体（payload）三部分构成。MQTT数据包结构如下：

**（1）固定头（Fixed header）。**存在于所有MQTT数据包中，表示数据包类型及数据包的分组类标识。

**（2）可变头（Variable header）。**存在于部分MQTT数据包中，数据包类型决定了可变头是否存在及其具体内容。

**（3）消息体（Payload）。**存在于部分MQTT数据包中，表示客户端收到的具体内容。

### 参考

[MQTT协议中文版](https://mcxiaoke.gitbooks.io/mqtt-cn/content/)